#!/bin/bash

basedir=`dirname $0`
cd $basedir
. ../../setup-env.sh

rm -fr  pmu_statsfile.txt stats_dump.iss.0 pa_dump.core.0 ./bin conv3x3a32_hvx128_out.bin conv3x3a32_hvx64_out.bin
mkdir -p bin
mkdir -p profile

g++-4.8 --std=c++11  -DLOG2VLEN=7 -DRUN=1 -DASSEMBLY=1 -DBITCODE=1 -I $HALIDE_ROOT/include -fno-rtti -O3 -g src/conv3x3a32_generator.cpp $HALIDE_ROOT/tools/GenGen.cpp -L$HALIDE_ROOT/lib -lHalide -o bin/conv3x3a32_generator -ldl -lpthread -lz

export LD_LIBRARY_PATH=$HALIDE_ROOT/lib:; ./bin/conv3x3a32_generator -o bin -e o,h,assembly,bitcode -g conv3x3a32 -f conv3x3a32_hvx64 target=hexagon-32-noos-no_bounds_query-no_asserts-hvx_64
export LD_LIBRARY_PATH=$HALIDE_ROOT/lib:; ./bin/conv3x3a32_generator -o bin -e o,h,assembly,bitcode -g conv3x3a32 -f conv3x3a32_hvx128 target=hexagon-32-noos-no_bounds_query-no_asserts-hvx_128
ar q bin/conv3x3a32_filters.a bin/conv3x3a32_hvx64.o bin/conv3x3a32_hvx128.o

hexagon-clang++ --std=c++11 -c -mhvx -mhvx-length=128B -mv66 -DLOG2VLEN=7 -I $HALIDE_ROOT/include -I ./bin -I ./baseline src/conv3x3a32_run.cpp -o bin/conv3x3a32_run.o

hexagon-clang++ -mhvx -mhvx-length=128B -mv66 -DLOG2VLEN=7 bin/conv3x3a32_run.o bin/conv3x3a32_filters.a -lhexagon -L$HALIDE_ROOT/lib -lsim_qurt $HALIDE_ROOT/Examples/support/stubs.c -o bin/conv3x3a32.out

if [ ! -z "${RUN_WITHOUT_TIMING}" ]; then
	printf "\nRunning simulator without --timing flag...\n"
	hexagon-sim bin/conv3x3a32.out -mv66 --memfill 0x0 --simulated_returnval --nullptr=2 -- 1920 1080 ../../testvectors/football1920x1080.bin out.bin
fi

printf "\nRunning simulator with --timing flag...\n"
hexagon-sim bin/conv3x3a32.out -mv66 --memfill 0x0 --simulated_returnval --nullptr=2 --timing --packet_analyze profile/conv3x3a32.json -- 1920 1080 ../../testvectors/football1920x1080.bin out.bin

hexagon-profiler --packet_analyze --elf=bin/conv3x3a32.out --json=profile/conv3x3a32.json -o profile/conv3x3a32.html

rm -fr stats_dump.iss.0 stats_dump.iss.1 pa_dump.core.0 pa_dump.core.1 pmu_statsfile.txt