#!/bin/bash

basedir=`dirname $0`
cd $basedir
. setup-env.sh
declare -i result=0
set -x

INCLUDES="-I /home/maaz/Desktop/Research/rake/halide/distrib/include -I /home/maaz/Desktop/Research/rake/halide/distrib/tools"
HL_LIBS="/home/maaz/Desktop/Research/rake/halide/distrib/lib/libHalide.a"

#############################################################################
cat <<EOT
=== Build Host/Hexagon executable for snapdragon device ===
EOT

rm -fr ./bin
mkdir -p bin/arm-64-android

${CXX} -std=c++11 $INCLUDES  -g -fno-rtti basic.cpp $HALIDE_ROOT/tools/GenGen.cpp -g $HL_LIBS -o bin/basic.generator -ldl -lpthread -lz -ldl -lpthread -lz -lz -lrt -ldl -ltinfo -lpthread

bin/basic.generator -g basic1 -o ./bin/arm-64-android target=arm-64-android-hvx_128
bin/basic.generator -g basic2 -o ./bin/arm-64-android target=arm-64-android-hvx_128
bin/basic.generator -g basic3 -o ./bin/arm-64-android target=arm-64-android-hvx_128
bin/basic.generator -g basic4 -o ./bin/arm-64-android target=arm-64-android-hvx_128
bin/basic.generator -g basic5 -o ./bin/arm-64-android target=arm-64-android-hvx_128
bin/basic.generator -g basic6 -o ./bin/arm-64-android target=arm-64-android-hvx_128
bin/basic.generator -g basic7 -o ./bin/arm-64-android target=arm-64-android-hvx_128
$ANDROID_ARM64_TOOLCHAIN/bin/aarch64-linux-android21-clang++ -fopenmp -std=c++11 $INCLUDES -I ./bin/arm-64-android -O3 \
		test.cpp \
		./bin/arm-64-android/basic1.a \
		./bin/arm-64-android/basic2.a \
		./bin/arm-64-android/basic3.a \
		./bin/arm-64-android/basic4.a \
		./bin/arm-64-android/basic5.a \
		./bin/arm-64-android/basic6.a \
		./bin/arm-64-android/basic7.a \
		-o bin/arm-64-android/test-hvx128 \
		-llog -fPIE -pie -Wall -ldl -lm -static-libstdc++

adb push bin/arm-64-android/test-hvx128 /data/
adb shell chmod +x /data/test-hvx128
#adb shell /data/test-hvx128

#${CXX} -fopenmp -std=c++11 $INCLUDES -I ./bin/host -O3 \
#		test.cpp \
#		./bin/host/basic1.a \
#		./bin/host/basic2.a \
#		./bin/host/basic3.a \
#		./bin/host/basic4.a \
#		./bin/host/basic5.a \
#		./bin/host/basic6.a \
#		./bin/host/basic7.a \
#		-o bin/host/test \
#		-Wall -lpthread -ldl -lm 
#./bin/host/test $1
#if [ $? -gt 0 ]; then ((result++)); fi

#bin/basic1.generator -g basic1 -o ./bin/host target=host-hvx_64
#${CXX} -fopenmp -std=c++11 $INCLUDES -Wall -I ./bin/host -O3 test.cpp ./bin/host/basic1.a -o bin/host/test -lpthread -ldl -lm
#./bin/host/test
#if [ $? -gt 0 ]; then ((result++)); fi

#bin/basic1.generator -g basic1 -o ./bin/host target=host
#${CXX} -fopenmp -std=c++11 $INCLUDES -Wall -I ./bin/host -O3 test.cpp ./bin/host/basic1.a -o bin/host/test -lpthread -ldl -lm
#./bin/host/test
#if [ $? -gt 0 ]; then ((result++)); fi

#exit $result